<?php $_product = Mage::getModel('catalog/product')->load(Mage::registry('current_product')->getId());?>
<?php $_helper = $this->helper('catalog/output'); ?>
<?php $_productName = strtolower($_product->getName());

?>
<div class="title-block">
	<div class="title-block-inner clearfix">
		<div class="title-block-container container clearfix">		
			<div id="bigtop-title" class="title">
				<span class="first">DROP CONFIGURATOR</span><br>
			</div>
		</div>
	</div>
</div>
<div class="fb-like-button-prod container">
    <?php echo $this->getBlockHtml('info.likebutton') ?>
</div>
<section class="container plan-configurator" ng-controller="buildPlan">
	
	<header>
		<!-- <div class="cart-message row sixteen-columns">
			<div class="male-cart-message">
				Listen up buddy, I've hooked you up with a plan specifically for you. Chop and change using the options below, and always remember one thing: from here on out, I got your arse covered.
			</div>
		</div> -->
		
		<div class="row sixteen-columns">
		</div>
		<div class="two-thirds column">

			<div class="basket-price">
				<div class="frequency-label label">Total:</div>
				<div class="price-block">
					<span class="currency-icon"><?php echo Mage::app()->getLocale()->currency(Mage::app()->getStore()->
	     getCurrentCurrencyCode())->getSymbol(); ?></span>
					<span class="special-price"><span id="final-price">{{plan.total}}</span></span>
				</div>
			</div>

			<div class="frequency-chooser">
				<div class="frequency-label label">Billed:</div>
		    	<a class="convert secondary lt active" id="trial-button" ng-click="freqChanger('trial')">Just once</a>
		    	<a class="convert secondary mid" id="quarterly-button" ng-click="freqChanger('quarterly')">Quarterly</a>
		    	<a class="convert secondary rt" id="biannually-button" ng-click="freqChanger('biannually')">Biannually</a>

		    	<!-- <span ng-repeat="drop in drops"><input type="radio" ng-model="plan.frequency" name="frequency" value="{{drop.value}}"/>{{drop.value}}</span> -->
		    </div>
		    
		</div>

		<div class="one-third column">
			<div class="shipping-label label">Free UK shipping & Returns</div>

			<form action="<?php echo $this->getSubmitUrl($_product) ?>" method="post" id="product_addtocart_form"<?php if($_product->getOptions()): ?> enctype="multipart/form-data"<?php endif; ?>>
		        <div class="no-display">
		            <input type="hidden" name="product" value="<?php echo $_product->getId() ?>" />
		            <input type="hidden" name="related_product" id="related-products-field" value="" />
		            
		        </div>
		        <div class="container2 no-display">
    <?php echo $this->getChildChildHtml('container2', '', true, true) ?>
    </div>

			    
			    <div class="bottom-stuff">


				    <div class="add-to-box">
				        <?php echo $this->getChildHtml('addtocart') ?>
				        <?php echo $this->getChildHtml('addto') ?>
						
						<?php /*
						<div class="delivery-date">
							<?php $profile = Mage::helper('randomquote')->getProfileEasyDate(); //remove Easy when enabling delivery drops?>
							<?php echo $this->__('This plan delivers between <br/><span class="actual-date">') . $profile['delivery_date'] . $this->__('</span><br/>and<br/><span class="actual-date">') . $profile['delivery_date2'] . $this->__('</span><br/> and every month after that');?>	
						</div>
						<?php */ ?>

				    </div>
				    
			    </div>

		    </form>
		</div>


	</header>
	
	
	

	<div id="messages_product_view"><?php echo $this->getMessagesBlock()->getGroupedHtml() ?></div>


	<?php
	$pieces = array(
		'Socks'		=> 'SOCKS',
		'Boxers'	=> 'BOXERS',
		'T-Shirts'	=> 'T-SHIRT',
		'Shirts'	=> 'SHIRT'
	);
	$relatedProductIds = array();
	foreach($_product->getRelatedLinkCollection() as $related) 	{
		$relatedProductIds[] = $related->getLinkedProductId();
	}
	?>
	

	<div id="st-accordion" class="st-accordion">
		<ul>

		<?php 
			$foreachIndex = 0; // we use this index to link the $pieces array key to the angular $scope.items array key

			foreach ($pieces as $k => $v) {
			$products = Mage::getModel('catalog/product')
				->getCollection()
				->addAttributeToSelect('image')
				->addAttributeToSelect('name')
				->addAttributeToSelect('rmscategory')
				->addAttributeToSelect('brand')
				->addAttributeToFilter('rmscategory', $v)
				->addAttributeToFilter('entity_id', array('in' => $relatedProductIds));	

			if ($products->count() > 0) {
		 ?>
		
			<li class="st-li ani" id="<?php echo strtolower($this->__($k));?>-section-summary">

                <div class="collapsed-configurables ani" ng-class="isZeroed(<?php echo $foreachIndex; ?>)">

                	<div class="one-third column">
						<div class="icon <?php echo $this->__($k);?>"></div>
						<div class="x-holder">x</div>
						<div class="quantity-selector">
							<div class="quantity-button-container {{items[<?php echo $foreachIndex; ?>].text}}-quantity">
								<div class="qty-label label">QTY:</div>
								<a class="convert secondary subtract-button" ng-click="subtract(items[<?php echo $foreachIndex; ?>],$index)">-</a><div class="qty-digit">{{items[<?php echo $foreachIndex; ?>].qty}}</div><a class="convert secondary add-button" ng-click="add(items[<?php echo $foreachIndex; ?>])">+</a>
							</div>
					    </div>
                	</div>

                	<div class="two-thirds column configure-brands-holder">
                		<div class="configure-brands clearfix {{items[<?php echo $foreachIndex; ?>].text}}-size">
                			<div class="upgrade-chooser item-<?php echo $foreachIndex; ?>">
                				<div class="brands-label label">BRANDS:</div>
				              	<a ng-repeat="upgrade in items[<?php echo $foreachIndex; ?>].upgrades" ng-click="calculateUpgradeSupplement(upgrade,items[<?php echo $foreachIndex; ?>], <?php echo $foreachIndex; ?>)" class="convert secondary upgrade {{items[<?php echo $foreachIndex; ?>].text}}-{{upgrade.value}}" ng-class="groupButtons($index,items[<?php echo $foreachIndex; ?>].upgrades)">{{upgrade.value}}</a>
					        </div>
                			
                		</div>
                		<div class="male-edit-holder">
	                		<div class="male-summary">
		                		<div class="male-summary-label label">MALE inputs:</div>
		                		<span class="selected">{{items[<?php echo $foreachIndex; ?>].chosenColour}}, {{items[<?php echo $foreachIndex; ?>].chosenOptions}}</span>
		                	</div>
						    
						    
			            </div>
			        <a href="#" class="opener convert secondary gradient">
	                	Edit
	                </a>    
                	</div>
                	
		            <div class="add-item-helper">
		            	{{addMessage[<?php echo $foreachIndex ?>].chosenPhrase}}
		            </div>
				</div>

		                
	                <!-- <div id="socks_style-text" style="float:none;" class="product-detail-checkbox nobg">style: <span>choose</span></div>
	                <div id="boxers_style-text" style="float:none;" class="product-detail-checkbox nobg">size: <span>choose</span></div> -->
	                
	                

			 	<!-- <div id="socks_style-text" style="float:none;" class="product-detail-checkbox nobg">Socks style: <span>choose</span></div>
				<div id="boxers_style-text" style="float:none;" class="product-detail-checkbox nobg">Boxers style: <span>choose</span></div> -->



			 	<div class="st-content clearfix">

					<div class="male-filter clearfix" id="{{items[<?php echo $foreachIndex; ?>].text}}-section-container">
						<?php // e.g. // id="customise-section-socks" ?>

						
						
						<?php /*Both*/ ?>
						<div class="isotope-holder two-thirds column">
							
								<?php foreach($products as $product): ?>
									<div class="filterable-product <?php

											echo $product->getName();


										?>">
										<img class="filterable" src="<?php echo $this->helper('catalog/image')->init($product, 'image')->resize(140, 140);?>" width="140" height="140" />
										
										<?php /* brand name ?>
										<div class="plan-item-details">
											<span class="black-title-small"><?php echo $product->getAttributeText('brand'); ?></span>
											<!-- span class="plan-item-rrp"><?php // echo 'RRP &pound;' . number_format($product->getPrice(),0); ?></span -->
										</div>
										<?php end brand name */ ?>

									</div>
									
								<?php endforeach; ?>
							
						</div>

						<div class="one-third column expanded-configurables">
							<ul>
					          <li class="{{items[<?php echo $foreachIndex; ?>].text}}-section configurables-holder">
					              
					              
				              	<div class="configure-size-holder row">
		                			<div class="configure-size clearfix {{items[<?php echo $foreachIndex; ?>].text}}-size">
										
										<div class="size-label label">SIZE:</div>
				                		
				                		<a ng-repeat="size in items[<?php echo $foreachIndex; ?>].sizes" class="convert secondary size-button {{items[<?php echo $foreachIndex; ?>].text}}-{{size.text}}" ng-class="groupButtons($index,items[<?php echo $foreachIndex; ?>].sizes)" ng-click="changeSize(items[<?php echo $foreachIndex; ?>], size,<?php echo $foreachIndex; ?>)">{{size.text}}</a>

					                </div>
					            </div>

		                		  <br/>
					              
					            <div class="{{items[<?php echo $foreachIndex; ?>].text}} colours row">
					              	<div class="colours-label label">COLOURS:</div>
					              	<a ng-repeat="index in itemOptions[<?php echo $foreachIndex; ?>].colours" class="convert secondary {{items[<?php echo $foreachIndex; ?>].text}}-{{index.buttonId}}" ng-click="toggleColour(index, <?php echo $foreachIndex; ?>)" ng-class="groupButtons($index,itemOptions[<?php echo $foreachIndex; ?>].colours" title="{{index.text}}">{{index.text}}</a>

					            </div>
					            <br/>
					            <div class="{{items[<?php echo $foreachIndex; ?>].text}} style row">
					              	<div class="colours-label label">STYLE:</div>
					              		<a ng-repeat="index in itemOptions[<?php echo $foreachIndex; ?>].options" class="convert secondary {{index.selected}} {{items[<?php echo $foreachIndex; ?>].text}}-{{index.buttonId}}" ng-click="toggleCustomOption(index,$index,<?php echo $foreachIndex; ?>)" ng-class="groupButtons($index,itemOptions[<?php echo $foreachIndex; ?>].options" title="{{index.text}}">{{index.text}}</a>
					            </div>
					          </li>
					        </ul>
					    </div>


					</div>
				</div> <!-- st-content -->

			</li>

			<?php 
				}; // end if
			
			$foreachIndex++;
			} // end foreach ?>
		</ul>
	</div> <!-- end st-accordion -->

		





	<?php // start buy box ?>








	<div class="plan product-info">
	    
	    
	</div>







	<?php // end buy box ?>








	<?php
		$upsells = $_product->getUpSellProductCollection()->addAttributeToSort('position', 'asc');
		if ($upsells->count() > 0):
	?>
	

	<div class="upsells">
		<h1 class="black-title-bar"><?php echo $this->__('Our Plans'); ?></h1>
		<ul>
		<?php foreach($upsells as $upsell): ?>
			<?php $upsellProduct = Mage::getModel('catalog/product')->load($upsell->getId()); ?>
			<li>
				<h3><span class="title">the</span><? echo $upsellProduct->getName(); ?></h3>
				<span class="price"><?php echo Mage::helper('core')->currency($upsellProduct->getPrice());?></span><br />
				<span class="special-price"><?php echo Mage::helper('core')->currency($upsellProduct->getSpecialPrice());?></span>
				<button class="button"><span><span><?php echo $this->__('View plan'); ?></span></span></button>
			</li>
		<?php endforeach; ?>
		</ul>
	</div>


	<?php endif; ?>


	<div class="extra-info">
			<?php echo $this->getLayout()->createBlock('cms/block')->setBlockId('plan-text-common')->toHtml(); ?>
    </div>

</section> <!-- end container -->







<script type="text/javascript">

    //<![CDATA[

    var $j = jQuery.noConflict();
	$j(document).ready(function() {
	  	
		$j(".male-cart-message").typewriter();

		if($isocontainer === undefined) {
	    	var $isocontainer = $j('.isotope-holder');
		    // initialize isotope
		    
	    }
	    
	    $isocontainer.isotope({
		    // options...
	    	itemSelector : '.filterable-product',
			layoutMode : 'masonry'
	    });


	  // accordian
		jQuery('#st-accordion').accordion({
			oneOpenedItem	: true
		});
	});




	// clear the cookies on page load
	if(jQuery.cookie("basket") != null) {
		jQuery.cookie("basket",null,{ path: '/'});
	}

	
	// $('product-options-wrapper').select('label').each(function(obj){
	// 	if (obj.innerHTML.toLowerCase().indexOf('shoe size') >= 0) {
	// 		obj.up().next().addClassName('sock-bg');
	// 		obj.up().next().innerHTML += '<span class="option-number"><?php echo $_product->getNumSocks(); ?>x</span>';
	// 	} else if (obj.innerHTML.toLowerCase().indexOf('t-shirt size') >= 0) {
	// 		obj.up().next().addClassName('t-shirt-bg');	
	// 		obj.up().next().innerHTML += '<span class="option-number"><?php echo $_product->getNumTshirts(); ?>x</span>';			
	// 	} else if (obj.innerHTML.toLowerCase().indexOf('boxer size') >= 0) {
	// 		obj.up().next().addClassName('boxer-bg');		
	// 		obj.up().next().innerHTML += '<span class="option-number"><?php echo $_product->getNumBoxers(); ?>x</span>';			
	// 	} else if (obj.innerHTML.toLowerCase().indexOf('shirt size') >= 0) {
	// 		obj.up().next().addClassName('shirt-bg');	
	// 		obj.up().next().innerHTML += '<span class="option-number"><?php echo $_product->getNumShirts(); ?>x</span>';
	// 	//upgrades
	// 	} else if (obj.innerHTML.toLowerCase().indexOf('boxer style') >= 0) {
	// 		obj.up().next().addClassName('boxer-bg style');
	// 		jQuery('.boxer-bg.style input').val('Both');
	// 	} else if (obj.innerHTML.toLowerCase().indexOf('sock style') >= 0) {
	// 		obj.up().next().addClassName('sock-bg style');
	// 		jQuery('.sock-bg.style input').val('Both');	
	// 	} else if (obj.innerHTML.toLowerCase().indexOf('t-shirt style') >= 0) {
	// 		obj.up().next().addClassName('t-shirt-bg style');
	// 		jQuery('.t-shirt-bg.style input').val('Designer T-shirts');	
	// 	} else if (obj.innerHTML.toLowerCase().indexOf('shirt style') >= 0) {
	// 		obj.up().next().addClassName('shirt-bg style');	
	// 		jQuery('.shirt-bg.style input').val('Work Shirts');	

	// 	} else if (obj.innerHTML.toLowerCase().indexOf('t-shirt upgrade') >= 0) {
	// 		obj.up().next().addClassName('t-shirt-bg upgrade');	
	// 		obj.up().next().innerHTML += '<span class="option-number additional">Choose style:</span>';
			
	// 	} else if (obj.innerHTML.toLowerCase().indexOf('shirt upgrade') >= 0) {
	// 		obj.up().next().addClassName('shirt-bg upgrade');
	// 		obj.up().next().innerHTML += '<span class="option-number additional">Choose style:</span>';
			
	// 	}
	// });
	


    var productAddToCartForm = new VarienForm('product_addtocart_form');
    productAddToCartForm.submit = function(button, url) {
        if (this.validator.validate()) {
            var form = this.form;
            var oldUrl = form.action;

            if (url) {
               form.action = url;
            }
            var e = null;
            try {
                this.form.submit();
            } catch (e) {
            }
            this.form.action = oldUrl;
            if (e) {
                throw e;
            }

            if (button && button != 'undefined') {
                button.disabled = true;
            }
        }
    }.bind(productAddToCartForm);

    productAddToCartForm.submitLight = function(button, url){
        if(this.validator) {
            var nv = Validation.methods;
            delete Validation.methods['required-entry'];
            delete Validation.methods['validate-one-required'];
            delete Validation.methods['validate-one-required-by-name'];
            if (this.validator.validate()) {
                if (url) {
                    this.form.action = url;
                }
                this.form.submit();
            }
            Object.extend(Validation.methods, nv);
        }
    }.bind(productAddToCartForm);
    //]]>
    </script>