<?php $_product = Mage::getModel('catalog/product')->load(Mage::registry('current_product')->getId());?>
<?php $_helper = $this->helper('catalog/output'); ?>
<?php $_productName = strtolower($_product->getName());

?>
<div class="title-block">
	<div class="title-block-inner clearfix">
		<div class="title-block-container container clearfix">		
			<div id="bigtop-title" class="title">
				<span class="first">DROP CONFIGURATOR</span><br>
			</div>
		</div>
	</div>
</div>
<div class="fb-like-button-prod container">
    <?php echo $this->getBlockHtml('info.likebutton') ?>
</div>
<section class="container plan-configurator" ng-controller="buildPlan">
	
	<header>
		<div class="cart-message row sixteen-columns">
			wattup
		</div>
		
		<div class="one-third column">
			<div class="basket-price">
				<span class="currency-icon"><?php echo Mage::app()->getLocale()->currency(Mage::app()->getStore()->
     getCurrentCurrencyCode())->getSymbol(); ?></span>
				<span class="special-price"><span id="final-price">{{plan.total}}</span></span>
			</div>
		</div>

		<div class="one-third column">
			<div class="frequency-chooser">
		    	<a class="convert secondary lt active" id="trial-button" ng-click="freqChanger('trial')">Just once</a>
		    	<a class="convert secondary mid" id="quarterly-button" ng-click="freqChanger('quarterly')">Quarterly</a>
		    	<a class="convert secondary rt" id="biannually-button" ng-click="freqChanger('biannually')">Biannually</a>

		    	<!-- <span ng-repeat="drop in drops"><input type="radio" ng-model="plan.frequency" name="frequency" value="{{drop.value}}"/>{{drop.value}}</span> -->
		    </div>
		</div>
		<div class="one-third column">


			<form action="<?php echo $this->getSubmitUrl($_product) ?>" method="post" id="product_addtocart_form"<?php if($_product->getOptions()): ?> enctype="multipart/form-data"<?php endif; ?>>
		        <div class="no-display">
		            <input type="hidden" name="product" value="<?php echo $_product->getId() ?>" />
		            <input type="hidden" name="related_product" id="related-products-field" value="" />
		            <div class="container2">
				    <?php echo $this->getChildChildHtml('container2', '', true, true) ?>
				    </div>
		        </div>
		
				
				<div class="price-box">
					<!-- <h3><span class="the"></span><span class="plan-category-grid-title"><?php // echo $_product->getName(); ?></span></h3> -->
					<div class="clearfix"></div>
			
				</div>
				

			    
			    <div class="bottom-stuff">


				    <div class="add-to-box">
				        <?php echo $this->getChildHtml('addtocart') ?>
				        <?php echo $this->getChildHtml('addto') ?>
						
						<?php /*
						<div class="delivery-date">
							<?php $profile = Mage::helper('randomquote')->getProfileEasyDate(); //remove Easy when enabling delivery drops?>
							<?php echo $this->__('This plan delivers between <br/><span class="actual-date">') . $profile['delivery_date'] . $this->__('</span><br/>and<br/><span class="actual-date">') . $profile['delivery_date2'] . $this->__('</span><br/> and every month after that');?>	
						</div>
						<?php */ ?>

				    </div>
				    
			    </div>
		    </form>
		</div>


	</header>
	
	
	

	<div id="messages_product_view"><?php echo $this->getMessagesBlock()->getGroupedHtml() ?></div>


	<?php
	$pieces = array(
		'Socks'		=> 'SOCKS',
		'Boxers'	=> 'BOXERS',
		'T-Shirts'	=> 'T-SHIRT',
		'Shirts'	=> 'SHIRT'
	);
	$relatedProductIds = array();
	foreach($_product->getRelatedLinkCollection() as $related) 	{
		$relatedProductIds[] = $related->getLinkedProductId();
	}
	?>
	

	<div id="st-accordion" class="st-accordion">
		<ul>

		<?php foreach ($pieces as $k => $v) {
			$products = Mage::getModel('catalog/product')
				->getCollection()
				->addAttributeToSelect('image')
				->addAttributeToSelect('name')
				->addAttributeToSelect('rmscategory')
				->addAttributeToSelect('brand')
				->addAttributeToFilter('rmscategory', $v)
				->addAttributeToFilter('entity_id', array('in' => $relatedProductIds));	

			if ($products->count() > 0) {
		 ?>
		
			<li class="st-li" id="<?php echo strtolower($this->__($k));?>-section-summary">

                <div class="collapsed-configurables">

                	<div class="one-third column">
						<div class="icon <?php echo $this->__($k);?>"></div>
						<div class="quantity-selector">
							<div ng-repeat="item in items" id="{{item.text}}-quantity">
							  <a class="convert secondary" ng-click="subtract(item)">-</a><span class="qty-digit">{{item.qty}}</span><a class="convert secondary" ng-click="add(item)">+</a>
							</div>
					    </div>

                	</div>

                	<div class="one-third column">
                		<div class="configure-size">
                			<a class="convert secondary lt active" id="trial-button" ng-click="sizeChanger('small')">6-9</a>
					    	<a class="convert secondary rt" id="biannually-button" ng-click="sizeChanger('large')">10-13</a>
                		</div>
                	</div>
                	<div class="one-third column">
					    <a href="#" class="opener convert secondary gradient">
		                	Edit
		                </a>
		            </div>
				</div>

		                
	                <!-- <div id="socks_style-text" style="float:none;" class="product-detail-checkbox nobg">style: <span>choose</span></div>
	                <div id="boxers_style-text" style="float:none;" class="product-detail-checkbox nobg">size: <span>choose</span></div> -->
	                
	                

			 	<!-- <div id="socks_style-text" style="float:none;" class="product-detail-checkbox nobg">Socks style: <span>choose</span></div>
				<div id="boxers_style-text" style="float:none;" class="product-detail-checkbox nobg">Boxers style: <span>choose</span></div> -->



			 	<div class="st-content">

					<div class="planOther" id="<?php echo strtolower($this->__($k));?>-section-container">
						<?php // e.g. // id="customise-section-socks" ?>

						<h1 class="black-title-bar main-view"><?php echo $this->__($k);?></h1>
						

						<ul>
				          <li ng-repeat="item in items" id="{{item.text}}-section">
				              
				              <span ng-repeat="index in item.options"><input id="" type="checkbox" ng-model="index.selected" ng-change="calculateOptionSupplement(index,item)"/>{{index.text}}</span>
				              <br/>
				              
				              
				              <?php /* shitty non-webkit browsers can't style checkboxes, so have to replicate with <a> tags */ ?>

				              <a ng-repeat="index in item.options" class="convert secondary {{index.selected}}" id="{{item.text}}-{{index.buttonId}}" ng-click="toggleCustomOption(index, item)" title="{{index.text}}">{{index.text}}</a>


				              <span ng-repeat="upgrade in item.upgrades"><input type="radio" ng-model="item.upgradeSupplement" name="upgrade1" value="{{upgrade.supplement}}" ng-change="calculateUpgradeSupplement(upgrade,item)"/>{{upgrade.value}}</span>

				              <br/><br/>
				          </li>
				        </ul>


						<?php /*Both*/ ?>
						<div class="isotope-holder">
							
								<?php foreach($products as $product): ?>
									<div class="filterable-product <?php

											echo $product->getName();


										?>">
										<img class="filterable" src="<?php echo $this->helper('catalog/image')->init($product, 'image')->resize(191, 229);?>" width="191" height="229" />
										<div class="plan-item-details">
											<span class="black-title-small"><?php echo $product->getAttributeText('brand'); ?></span>
											<!-- span class="plan-item-rrp"><?php // echo 'RRP &pound;' . number_format($product->getPrice(),0); ?></span -->
										</div>
									</div>
									
								<?php endforeach; ?>
							
						</div>

					</div>
				</div> <!-- st-content -->

			</li>

			<?php 
				}; // end if
			} // end foreach ?>
		</ul>
	</div> <!-- end st-accordion -->

		





	<?php // start buy box ?>








	<div class="plan product-info">
	    
	    
	</div>







	<?php // end buy box ?>








	<?php
		$upsells = $_product->getUpSellProductCollection()->addAttributeToSort('position', 'asc');
		if ($upsells->count() > 0):
	?>
	

	<div class="upsells">
		<h1 class="black-title-bar"><?php echo $this->__('Our Plans'); ?></h1>
		<ul>
		<?php foreach($upsells as $upsell): ?>
			<?php $upsellProduct = Mage::getModel('catalog/product')->load($upsell->getId()); ?>
			<li>
				<h3><span class="title">the</span><? echo $upsellProduct->getName(); ?></h3>
				<span class="price"><?php echo Mage::helper('core')->currency($upsellProduct->getPrice());?></span><br />
				<span class="special-price"><?php echo Mage::helper('core')->currency($upsellProduct->getSpecialPrice());?></span>
				<button class="button"><span><span><?php echo $this->__('View plan'); ?></span></span></button>
			</li>
		<?php endforeach; ?>
		</ul>
	</div>


	<?php endif; ?>


	<div class="extra-info">
       		<?php echo $this->getLayout()->createBlock('cms/block')->setBlockId('plan-text-' . $_product->getSku())->toHtml(); ?>
			<?php echo $this->getLayout()->createBlock('cms/block')->setBlockId('plan-text-common')->toHtml(); ?>
    </div>

</section> <!-- end container -->







<script type="text/javascript">

    //<![CDATA[

    var $j = jQuery.noConflict();
	$j(document).ready(function() {
	  
		if($isocontainer === undefined) {
	    	var $isocontainer = $j('.isotope-holder');
		    // initialize isotope
		    
	    }
	    
	    $isocontainer.isotope({
		    // options...
	    	itemSelector : '.filterable-product',
			layoutMode : 'masonry'
	    });


	  // accordian
		jQuery('#st-accordion').accordion({
			oneOpenedItem	: true
		});
	});




	// clear the cookies on page load
	if(jQuery.cookie("basket") != null) {
		jQuery.cookie("basket",null,{ path: '/'});
	}

	
	// $('product-options-wrapper').select('label').each(function(obj){
	// 	if (obj.innerHTML.toLowerCase().indexOf('shoe size') >= 0) {
	// 		obj.up().next().addClassName('sock-bg');
	// 		obj.up().next().innerHTML += '<span class="option-number"><?php echo $_product->getNumSocks(); ?>x</span>';
	// 	} else if (obj.innerHTML.toLowerCase().indexOf('t-shirt size') >= 0) {
	// 		obj.up().next().addClassName('t-shirt-bg');	
	// 		obj.up().next().innerHTML += '<span class="option-number"><?php echo $_product->getNumTshirts(); ?>x</span>';			
	// 	} else if (obj.innerHTML.toLowerCase().indexOf('boxer size') >= 0) {
	// 		obj.up().next().addClassName('boxer-bg');		
	// 		obj.up().next().innerHTML += '<span class="option-number"><?php echo $_product->getNumBoxers(); ?>x</span>';			
	// 	} else if (obj.innerHTML.toLowerCase().indexOf('shirt size') >= 0) {
	// 		obj.up().next().addClassName('shirt-bg');	
	// 		obj.up().next().innerHTML += '<span class="option-number"><?php echo $_product->getNumShirts(); ?>x</span>';
	// 	//upgrades
	// 	} else if (obj.innerHTML.toLowerCase().indexOf('boxer style') >= 0) {
	// 		obj.up().next().addClassName('boxer-bg style');
	// 		jQuery('.boxer-bg.style input').val('Both');
	// 	} else if (obj.innerHTML.toLowerCase().indexOf('sock style') >= 0) {
	// 		obj.up().next().addClassName('sock-bg style');
	// 		jQuery('.sock-bg.style input').val('Both');	
	// 	} else if (obj.innerHTML.toLowerCase().indexOf('t-shirt style') >= 0) {
	// 		obj.up().next().addClassName('t-shirt-bg style');
	// 		jQuery('.t-shirt-bg.style input').val('Designer T-shirts');	
	// 	} else if (obj.innerHTML.toLowerCase().indexOf('shirt style') >= 0) {
	// 		obj.up().next().addClassName('shirt-bg style');	
	// 		jQuery('.shirt-bg.style input').val('Work Shirts');	

	// 	} else if (obj.innerHTML.toLowerCase().indexOf('t-shirt upgrade') >= 0) {
	// 		obj.up().next().addClassName('t-shirt-bg upgrade');	
	// 		obj.up().next().innerHTML += '<span class="option-number additional">Choose style:</span>';
			
	// 	} else if (obj.innerHTML.toLowerCase().indexOf('shirt upgrade') >= 0) {
	// 		obj.up().next().addClassName('shirt-bg upgrade');
	// 		obj.up().next().innerHTML += '<span class="option-number additional">Choose style:</span>';
			
	// 	}
	// });
	


    var productAddToCartForm = new VarienForm('product_addtocart_form');
    productAddToCartForm.submit = function(button, url) {
        if (this.validator.validate()) {
            var form = this.form;
            var oldUrl = form.action;

            if (url) {
               form.action = url;
            }
            var e = null;
            try {
                this.form.submit();
            } catch (e) {
            }
            this.form.action = oldUrl;
            if (e) {
                throw e;
            }

            if (button && button != 'undefined') {
                button.disabled = true;
            }
        }
    }.bind(productAddToCartForm);

    productAddToCartForm.submitLight = function(button, url){
        if(this.validator) {
            var nv = Validation.methods;
            delete Validation.methods['required-entry'];
            delete Validation.methods['validate-one-required'];
            delete Validation.methods['validate-one-required-by-name'];
            if (this.validator.validate()) {
                if (url) {
                    this.form.action = url;
                }
                this.form.submit();
            }
            Object.extend(Validation.methods, nv);
        }
    }.bind(productAddToCartForm);
    //]]>
    </script>