<?php
Mage::helper('recurly')->config();
$customerId = Mage::getSingleton('customer/session')->getId();
$customerEmail = Mage::getModel('customer/customer')->load($customerId)->getEmail();
$sku = Mage::helper('recurly')->getSku();
$onceOff = $this->_isOnceOff();
$signature = $onceOff ? Mage::helper('recurly')->signOneTimeTransaction($customerId)  : Mage::helper('recurly')->signSubscription($sku, $customerId);
Mage::getSingleton('core/session')->setSignature($signature);
var_dump($onceOff);
?>
<script type="text/javascript">

document.observe('dom:loaded', function(){

	var shipField = document.getElementById("shipping:country_id");
	var countryShip = shipField.options[shipField.selectedIndex].value;
	var intlSku = "";		
	if(countryShip != 'GB') {
		intlSku = "-intl";
	}

	loadRecurly(
		'<?php echo Mage::helper('recurly')->getSubdomain(); ?>'
		, '<?php echo Mage::helper('recurly')->getCurrency(); ?>'
		, '<?php echo Mage::helper('recurly')->getCountry(); ?>'
		, '<?php echo $sku; ?>' + intlSku
		, '<?php echo $customerId; ?>'
		, '<?php echo Mage::getUrl('', array('_secure' => true)) . 'recurly/callback/success/'; ?>'
		, '<?php echo $customerEmail; ?>'
		, '<?php echo $signature; ?>'
		, '<?php echo ($onceOff) ? 'once-off' : 'subscription'; ?>'
	);
});
</script>

<script type="text/javascript">
	document.observe('dom:loaded', function(){

				/*
				*  insert tooltip
				*  
				*/
				
				var toolDivAttrs = {
	                'id'   : 'popover',
	                'class'   : 'popover top'
	            };
	            
	            var arrowDivAttrs = {
	                'id'   : 'arrow',
	                'class'   : 'arrow'
	            };
				var popInnerAttrs = {
	                'id'   : 'popover-inner',
	                'class'   : 'popover-inner'
	            };
	            var popTitleAttrs = {
	                'id'   : 'popover-title',
	                'class'   : 'popover-title'
	            };
	            var popContentAttrs = {
	                'id'   : 'popover-content',
	                'class'   : 'popover-content'
	            };
	 			
	 			// insert close tooltip
	            var toolDiv = new Element('div', toolDivAttrs);
	            var arrowDiv = new Element('div', arrowDivAttrs);
	            var popInnerDiv = new Element('div', popInnerAttrs);
	            var popTitleDiv = new Element('h3', popTitleAttrs);
	            popTitleDiv.update('Return Like a Man&trade; (+Â£2.49)');
	            var popContentDiv = new Element('p', popContentAttrs);
				popContentDiv.update('<p>Choose this and we\'ll arrange a free, fully insured courier to come pick up anything you want to return or exchange. Otherwise, no dramas, just post it back to us yourself if you want to return anything.</p>');

				jQuery('.add_ons.any').prepend(toolDiv);				
				jQuery('#popover').append(arrowDiv);
				jQuery('#popover').append(popInnerDiv);
				jQuery('#popover-inner').append(popTitleDiv);
				jQuery('#popover-inner').append(popContentDiv);

				jQuery("#popover").css('display','none'); //start hidden

				jQuery(".add_ons.any").hover(
				  function () {
				    jQuery("#popover").fadeIn(500);
				  },
				  function () {
				    jQuery("#popover").fadeOut(500);
				  }
				);				
				/* end insert cookie based close button */
	});
</script>
